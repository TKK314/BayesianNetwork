# 1.離散型データ事例

## 1.2グラフィカル表現

```{r}
library(bnlearn)
dag <- empty.graph(nodes=c("A","S","E","O","R","T"))
dag
```

```{r}
dag <- set.arc(dag, from="A", to="E")
dag <- set.arc(dag, from="S", to="E")

dag <- set.arc(dag, from="E", to="O")
dag <- set.arc(dag, from="E", to="R")

dag <- set.arc(dag, from="O", to="T")
dag <- set.arc(dag, from="R", to="T")

dag
```

関数の説明

```{r}
nodes(dag)
```

```{r}
arcs(dag)
```

まとめてアークを追加することも可能

```{r}
dag2 <- empty.graph(nodes = c("A","S","E","O","R","T"))
arc.set <- matrix(c("A","E",
                    "S","E",
                    "E","O",
                    "E","R",
                    "O","T",
                    "R","T"),
                  byrow =TRUE, ncol = 2,
                  dimnames = list(NULL, c("from", "to")))
arcs(dag2) <- arc.set
dag2
```

```{r}
#同一か確認
all.equal(dag,dag2)
```

```{r}
#循環している場合エラーがでる
set.arc(dag, from = "T", to = "E")
```

## 1.3確率的表現

BNを作成するに当たり変数に同時確率分布を導入する必要あり

すべて離散型データなのでRにおいて水準(level)という非連続状態のデータセットを定義する必要あり

```{r}
A.lv <-c("young","adult","old")
S.lv <-c("M","F")
E.lv <-c("high","uni")
O.lv <-c("emp","self")
R.lv <-c("small","big")
T.lv <-c("car","train","other")
```

```{r}
A.prob <-array(c(0.30,0.50,0.20), dim=3, dimnames = list(A = A.lv))
A.prob
```

```{r}
S.prob <-array(c(0.60,0.40), dim=2, dimnames = list(S = S.lv))
S.prob
```

```{r}
O.prob <-matrix(c(0.96,0.04,0.92,0.08), ncol = 2, dimnames = list(O=O.lv, E=E.lv))
O.prob
```

```{r}
R.prob <-matrix(c(0.25,0.75,0.20,0.80), ncol = 2, dimnames = list(R=R.lv, E=E.lv))
R.prob
```

```{r}
E.prob <-array(c(0.75,0.25,0.72,0.28,0.88,0.12,0.64,0.36,0.70,0.30,0.90,0.10), dim = c(2,3,2), dimnames = list(E=E.lv, A=A.lv, S=S.lv))
E.prob
```

```{r}
T.prob <-array(c(0.48,0.42,0.10,0.56,0.36,0.08,0.58,0.24,0.18,0.70,0.21,0.09), dim = c(3,2,2), dimnames = list(T=T.lv, O=O.lv, R=R.lv))
T.prob
```

上記の条件付き確率表とDAGを組み合わせる必要あり

```{r}
#以下のように直接ネットワークを記述することも可能
dag3 <- model2network("[A][S][E|A:S][O|E][R|E][T|O:R]")
```

```{r}
#cptは条件付き確率表を意味する
cpt <- list(A = A.prob, S = S.prob, E = E.prob, O = O.prob, R = R.prob, T= T.prob)
bn <- custom.fit(dag, cpt)
```

```{r}
#パラメータ数確認
nparams(bn)
```

```{r}
#arc確認
arcs(bn)
```

```{r}
#条件付き確率表を示せる
bn$R
```

```{r}
#条件付き確率表部分のみを出せる
coef(bn$R)
```

```{r}
#全体を示す
bn
```

## 1.4パラメータの推定：条件付き確率表

```{r}
survey <- read.table("survey.txt", header = TRUE, colClasses = "factor")
```

パラメータ=局所的分布における条件付き確率そのもの

```{r}
#bn.fit関数を用いることでデータからパラメータ推定可能
#mleは最尤推定法を用いている
bn.mle <- bn.fit(dag, data = survey, method = "mle")

bn.mle$O
```

```{r}
#bayesにすると事後分布を用いたベイズ的方法になる
bn.bayes <- bn.fit(dag, data = survey, method = "bayes", iss = 10)
bn.bayes$O
```

iss (imaginary sample size)はオプション：事前分布にどの程度重み付けするか

小さい値（1-15）にするのが一般的、値が大きいと事後分布が一様になり事前分布として用いられた一様分布へと近似していく

ベイズのほうがより1から遠い値となる→0を含むセルが減る

最尤推定法よりもロバストで予測力の高いベイジアンネットワークを構築可能

## 1.5DAG構造の学習：検定とスコア

-   DAGの構造を探索していくこと自体が調査の目的の場合もある

-   どのノードが分析対象のノードと直接関連があるか特定可能

### 1.5.1条件付き独立性検定

個々のアークの有無に焦点を当てたもの

条件付き独立の帰無仮説（確率的に独立である）が棄却されるならそのアークをDAGの中に加えることができる

```{r}
#ci.test関数で対数尤度比検定、Χ2検定が可能
ci.test("T","E",c("O","R"),test = "mi", data = survey)
```

```{r}
ci.test("T","E",c("O","R"),test = "x2", data = survey)
```

いずれもp値が大きいため、E→Tの関連性で有意差なし→現在のDAG構造に加えるような関連性なし

```{r}
#まとめて検定を実施可能
arc.strength(dag, data = survey, criterion = "x2")
```

O→T以外のすべてのアークは支持されたものと判断可能

### 1.5.2ネットワークスコア

ネットワーク全体としてのDAGに焦点を当てている。

DAGがデータの依存構造をどの程度よく反映しているかの適合度指標

$$
BIC = \log\widehat{Pr}(A,S,E,O,R,T) - \frac{d}{2}\log n
$$

n：サンプルサイズ、d：ネットワーク全体のパラメータ数

DAGがデータにフィットしているほど高い値を示す

```{r}
#BIC
score(dag, data = survey, type = "bic")
```

```{r}
#対数BDe
score(dag, data = survey, type = "bde", iss = 10)
```

```{r}
#例としてランダムグラフを作ってみるとさすがにスコアが悪い
rnd <- random.graph(nodes = c("A","S","E","O","R","T"))
modelstring(rnd)
score(rnd, data = survey, type = "bic")
```

ネットワークのスコアが最大となるDAGを探索するためのアルゴリズム

-   山登り法

    -   アークなしのDAGからスタートして1つひとつのアークを順次追加、除去、反転させることで最もネットワークスコアが増加する状況を探索する方法

    -   hcを使ったらデフォルトはbicで計算される

```{r}
learned <- hc(survey)
modelstring(learned)
```

```{r}
score(learned, data = survey, type = "bic")
```

```{r}
arc.strength(learned, data = survey, criterion = "bic")
```

## 1.6離散型データでベイジアンネットワークを使ってみよう
